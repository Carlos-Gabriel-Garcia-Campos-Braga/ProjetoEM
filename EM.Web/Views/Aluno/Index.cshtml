@model IEnumerable<EM.Domain.Aluno>

@{
    ViewData["Title"] = "Gerenciar Alunos";
}

<div class="container mt-4">
    @if (TempData["Erro"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong><i class="bi bi-exclamation-triangle"></i> Erro!</strong>
            <pre style="white-space: pre-wrap;">@TempData["Erro"]</pre>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary">Gerenciar Alunos</h2>
        <div class="d-flex gap-2">
            <a asp-action="GerarRelatorio" class="btn btn-danger" target="_blank">
                <i class="bi bi-file-pdf"></i> Gerar Relatório PDF
            </a>
            <a asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Adicionar Aluno
            </a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros de Busca</h5>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Index">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="busca" class="form-label">Matrícula ou Nome</label>
                        <input type="text" name="busca" id="busca" class="form-control" placeholder="Digite aqui..." value="@ViewBag.Busca" />
                    </div>
                    <div class="col-md-3">
                        <label for="sexo" class="form-label">Sexo</label>
                        <select name="sexo" id="sexo" class="form-select">
                            <option value="">Todos</option>
                            @if (ViewBag.SexoList != null)
                            {
                                @foreach (EM.Domain.Utilitarios.Sexo sexoItem in ViewBag.SexoList)
                                {
                                    <option value="@((int)sexoItem)" selected="@(ViewBag.SexoFiltro == (int)sexoItem)">@sexoItem</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="cidadeId" class="form-label">Cidade</label>
                        <select name="cidadeId" id="cidadeId" class="form-select">
                            <option value="">Todas</option>
                            @if (ViewBag.CidadeList != null)
                            {
                                @foreach (EM.Domain.Cidade cidade in ViewBag.CidadeList)
                                {
                                    <option value="@cidade.Id" selected="@(ViewBag.CidadeFiltro == cidade.Id)">@cidade.NomeDaCidade - @cidade.UF</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="uf" class="form-label">Estado (UF)</label>
                        <select name="uf" id="uf" class="form-select">
                            <option value="">Todos</option>
                            @if (ViewBag.UFList != null)
                            {
                                @foreach (EM.Domain.Utilitarios.UF ufItem in ViewBag.UFList)
                                {
                                    <option value="@((int)ufItem)" selected="@(ViewBag.UFFiltro == (int)ufItem)">@ufItem</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Limpar Filtros
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    

    <div class="card">
        <div class="card-body">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th class="text-center">Matrícula</th>
                                <th class="text-center">Nome</th>
                                <th class="text-center">CPF</th>
                                <th class="text-center">Data de Nascimento</th>
                                <th class="text-center">Sexo</th>
                                <th class="text-center">Cidade</th>
                                <th class="text-center" style="width: 180px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var aluno in Model)
                            {
                                <tr>
                                    <td class="text-center">@aluno.Matricula</td>
                                    <td class="text-center">@aluno.Nome</td>
                                    <td class="text-center">@(string.IsNullOrWhiteSpace(aluno.Cpf?.CpfFormatado) ? "-" : aluno.Cpf.CpfFormatado)</td>
                                    <td class="text-center">@aluno.DataNascimento.ToString("dd/MM/yyyy")</td>
                                    <td class="text-center">@aluno.Sexo</td>
                                    <td class="text-center">@(aluno.Cidade != null ? $"{aluno.Cidade.NomeDaCidade} - {aluno.Cidade.UF}" : "-")</td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a asp-action="Edit" asp-route-matricula="@aluno.Matricula" class="btn btn-sm btn-warning">
                                                <i class="bi bi-pencil"></i> Editar
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="confirmarExclusao(@aluno.Matricula, '@aluno.Nome')">
                                                <i class="bi bi-trash"></i> Excluir
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-info text-center" role="alert">
                    <i class="bi bi-info-circle"></i> Nenhum aluno encontrado.
                </div>
            }
        </div>
    </div>
</div>

<form id="formExcluir" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1" aria-labelledby="modalConfirmarExclusaoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmarExclusaoLabel">
                    <i class="bi bi-exclamation-triangle text-warning"></i> Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o aluno <strong id="nomeAlunoExclusao"></strong> (Matrícula: <strong id="matriculaExclusao"></strong>)?</p>
                <p class="text-danger mb-0"><small>Esta ação não pode ser desfeita.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">
                    <i class="bi bi-trash"></i> Excluir
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let matriculaParaExcluir = null;

        function confirmarExclusao(matricula, nome) {
            matriculaParaExcluir = matricula;
            document.getElementById('nomeAlunoExclusao').textContent = nome;
            document.getElementById('matriculaExclusao').textContent = matricula;
            
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmarExclusao'));
            modal.show();
        }

        document.getElementById('btnConfirmarExclusao').addEventListener('click', function() {
            if (matriculaParaExcluir !== null) {
                const form = document.getElementById('formExcluir');
                form.action = '@Url.Action("Delete", "Aluno")?matricula=' + matriculaParaExcluir;
                form.submit();
            }
        });
    </script>
}
